{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify jazzmin %}

{% block breadcrumbs %}{% endblock %}
{% block nav-breadcrumbs %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* Página do Post: limpa o topo (breadcrumbs) e dá um ar mais "editor" */
    body.model-post.change-form .content-header,
    body.model-post.change-form .breadcrumb,
    body.model-post.change-form .breadcrumbs {
      display: none !important;
    }

    body.model-post.change-form #content {
      padding-top: 14px;
    }

    .oxira-editor-tip {
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(220,38,38,.04);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 14px;
    }
    .oxira-editor-tip strong { font-weight: 900; }
    .oxira-editor-tip .muted { color: rgba(107,114,128,.95); }

    /* Tooltip "?" (mesmo estilo do dashboard) */
    .oxira-help {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid rgba(107, 114, 128, .35);
      color: rgba(107, 114, 128, .95);
      font-weight: 900;
      font-size: 10px;
      line-height: 1;
      cursor: help;
      user-select: none;
      position: relative;
      top: -1px;
      z-index: 9999;
    }

    .oxira-help:hover {
      border-color: rgba(220, 38, 38, .55);
      color: rgba(220, 38, 38, 1);
      background: rgba(220, 38, 38, .08);
    }

    .oxira-help[data-tip]::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translate(-50%, -100%);
      background: rgba(255, 255, 255, .98);
      color: rgba(17, 24, 39, .96);
      border: 1px solid rgba(0,0,0,.08);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 650;
      letter-spacing: 0;
      text-transform: none;
      width: max-content;
      max-width: 360px;
      white-space: normal;
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease;
      z-index: 100000;
    }

    .oxira-help[data-tip]::before {
      content: "";
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translate(-50%, -2px);
      border: 6px solid transparent;
      border-top-color: rgba(255, 255, 255, .98);
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.06));
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease;
      z-index: 100001;
    }

    .oxira-help:hover::after,
    .oxira-help:hover::before {
      opacity: 1;
    }

    /* Evita o tooltip ser cortado por containers com overflow */
    body.model-post.change-form .card,
    body.model-post.change-form .module,
    body.model-post.change-form fieldset.module {
      overflow: visible !important;
    }

    /* Deixa labels mais “editor” */
    body.model-post.change-form label {
      font-weight: 800;
    }

    /* Remove a faixa vermelha padrão do admin (somente Post) */
    body.model-post.change-form .errornote {
      display: none !important;
    }

    /* Modal de erro (popup) */
    body.model-post.change-form .oxira-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, .55);
      backdrop-filter: blur(3px);
      z-index: 200000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    body.model-post.change-form .oxira-modal {
      width: min(720px, 100%);
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
      overflow: hidden;
    }

    body.model-post.change-form .oxira-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(220,38,38,.10), rgba(255,255,255,1));
    }

    body.model-post.change-form .oxira-modal-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 950;
      letter-spacing: .2px;
      color: rgba(17,24,39,.92);
      margin: 0;
      font-size: 15px;
    }

    body.model-post.change-form .oxira-modal-title .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(220,38,38,.14);
      color: rgba(220,38,38,1);
      font-weight: 900;
      border: 1px solid rgba(220,38,38,.18);
    }

    body.model-post.change-form .oxira-modal-body {
      padding: 14px 16px 10px;
      color: rgba(31,41,55,.92);
      font-size: 13px;
    }

    body.model-post.change-form .oxira-modal-body .muted {
      color: rgba(107,114,128,.95);
      margin-bottom: 10px;
    }

    body.model-post.change-form .oxira-error-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    body.model-post.change-form .oxira-error-item {
      border: 1px solid rgba(220,38,38,.16);
      background: rgba(220,38,38,.06);
      border-radius: 14px;
      padding: 10px 12px;
    }

    body.model-post.change-form .oxira-error-item strong {
      display: block;
      font-weight: 950;
      margin-bottom: 4px;
      color: rgba(127,29,29,.98);
    }

    body.model-post.change-form .oxira-error-item ul {
      margin: 0;
      padding-left: 16px;
    }

    body.model-post.change-form .oxira-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 12px 16px;
      border-top: 1px solid rgba(0,0,0,.06);
      background: #fff;
    }

    body.model-post.change-form .oxira-modal-footer .btn {
      border-radius: 12px;
      font-weight: 900;
    }

    /* ===== Visual clean/moderno (apenas Post) ===== */
    body.model-post.change-form .oxira-editor-tip {
      background: #fff;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 8px 24px rgba(0,0,0,.04);
    }

    /* Cards/fieldsets mais leves */
    body.model-post.change-form .card,
    body.model-post.change-form .module,
    body.model-post.change-form fieldset.module {
      border-radius: 16px !important;
      border: 1px solid rgba(0,0,0,.06) !important;
      box-shadow: 0 10px 28px rgba(0,0,0,.04) !important;
      overflow: hidden;
    }

    body.model-post.change-form .card-header,
    body.model-post.change-form .module h2,
    body.model-post.change-form fieldset.module > h2 {
      border-bottom: 1px solid rgba(0,0,0,.06) !important;
      background: #fff !important;
    }

    /* Mata aquele “gradeado”/linhas entre campos */
    body.model-post.change-form .form-row {
      border-bottom: 0 !important;
      padding-bottom: 0 !important;
      margin-bottom: 14px !important;
    }

    /* Botões inline (ex.: inserir anúncio) */
    body.model-post.change-form .oxira-inline-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-left: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(17,24,39,.02);
      color: rgba(17,24,39,.92);
      font-weight: 900;
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      cursor: pointer;
      user-select: none;
    }
    body.model-post.change-form .oxira-inline-btn:hover {
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.06);
      color: rgba(220,38,38,1);
    }

    /* Layout: label em cima do campo, tudo mais compacto */
    body.model-post.change-form .aligned .form-row,
    body.model-post.change-form .form-row {
      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 6px;
    }

    body.model-post.change-form .form-row > div,
    body.model-post.change-form .form-row .fieldBox,
    body.model-post.change-form .form-row .flex-container {
      float: none !important;
      width: 100% !important;
      max-width: 100% !important;
    }

    body.model-post.change-form label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: rgba(17, 24, 39, .92);
      margin: 0 !important;
      padding: 0 !important;
    }

    body.model-post.change-form .help,
    body.model-post.change-form .helptext,
    body.model-post.change-form .form-row .help,
    body.model-post.change-form .form-row .helptext {
      margin-top: 6px !important;
      color: rgba(107,114,128,.95) !important;
      font-size: 12px !important;
    }

    /* Inputs modernos */
    body.model-post.change-form input[type="text"],
    body.model-post.change-form input[type="number"],
    body.model-post.change-form input[type="url"],
    body.model-post.change-form input[type="email"],
    body.model-post.change-form input[type="search"],
    body.model-post.change-form input[type="datetime-local"],
    body.model-post.change-form input.vTextField,
    body.model-post.change-form select,
    body.model-post.change-form textarea {
      width: 100% !important;
      max-width: 100% !important;
      padding: 10px 12px !important;
      border-radius: 12px !important;
      border: 1px solid rgba(0,0,0,.12) !important;
      background: #fff !important;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    body.model-post.change-form input::placeholder,
    body.model-post.change-form textarea::placeholder {
      color: rgba(156,163,175,.95);
    }

    body.model-post.change-form input[type="text"]:focus,
    body.model-post.change-form input[type="number"]:focus,
    body.model-post.change-form input[type="url"]:focus,
    body.model-post.change-form input[type="email"]:focus,
    body.model-post.change-form input[type="search"]:focus,
    body.model-post.change-form input[type="datetime-local"]:focus,
    body.model-post.change-form input.vTextField:focus,
    body.model-post.change-form select:focus,
    body.model-post.change-form textarea:focus {
      outline: none !important;
      border-color: rgba(220,38,38,.65) !important;
      box-shadow: 0 0 0 4px rgba(220,38,38,.12) !important;
    }

    /* raw_id_fields (Autor) mais amigável */
    body.model-post.change-form .related-widget-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
    }
    body.model-post.change-form .related-widget-wrapper input {
      flex: 1 1 220px;
      min-width: 180px;
    }
    body.model-post.change-form .related-widget-wrapper a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      color: rgba(17,24,39,.9);
      font-weight: 800;
      text-decoration: none;
    }
    body.model-post.change-form .related-widget-wrapper a:hover {
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.05);
      color: rgba(220,38,38,1);
    }

    /* CKEditor: borda/raio alinhados ao resto */
    body.model-post.change-form .cke {
      border-radius: 16px !important;
      border: 1px solid rgba(0,0,0,.10) !important;
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,.04) !important;
    }
    body.model-post.change-form .cke_top {
      background: #fff !important;
      border-bottom: 1px solid rgba(0,0,0,.06) !important;
    }
    body.model-post.change-form .cke_contents {
      background: #fff !important;
    }

    /* Mobile: deixa o editor utilizável (de quebra-galho) */
    @media (max-width: 640px) {
      /* Evita "scroll duplo" e cortes horizontais */
      body.model-post.change-form #content {
        padding-left: 12px;
        padding-right: 12px;
      }

      /* Campos e widgets sempre 100% */
      body.model-post.change-form .form-row,
      body.model-post.change-form .aligned,
      body.model-post.change-form .fieldBox,
      body.model-post.change-form .form-row .fieldBox,
      body.model-post.change-form .form-row .flex-container,
      body.model-post.change-form .form-row input,
      body.model-post.change-form .form-row select,
      body.model-post.change-form .form-row textarea {
        max-width: 100% !important;
      }

      /* CKEditor: container 100% */
      body.model-post.change-form .django-ckeditor-widget,
      body.model-post.change-form .cke,
      body.model-post.change-form .cke_inner,
      body.model-post.change-form .cke_contents,
      body.model-post.change-form .cke_contents iframe {
        width: 100% !important;
        max-width: 100% !important;
      }

      /* CKEditor: toolbar quebra linha e botões maiores */
      body.model-post.change-form .cke_top {
        padding: 8px 8px 6px !important;
      }
      body.model-post.change-form .cke_toolbox {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 6px 8px !important;
      }
      body.model-post.change-form .cke_toolbar {
        float: none !important;
        margin: 0 !important;
      }
      body.model-post.change-form .cke_combo,
      body.model-post.change-form .cke_toolbar_group {
        margin: 0 !important;
      }
      body.model-post.change-form .cke_button,
      body.model-post.change-form .cke_combo_button {
        padding: 7px 8px !important;
      }
      body.model-post.change-form .cke_button_icon {
        transform: scale(1.05);
      }

      /* Área de edição com altura boa no mobile */
      body.model-post.change-form .cke_contents {
        min-height: 360px !important;
      }

      /* Tooltips: não estoura na tela pequena */
      .oxira-help[data-tip]::after {
        max-width: min(320px, calc(100vw - 24px));
      }
    }

    /* ===== Ações no rodapé (em vez de lateral) ===== */
    body.model-post.change-form .oxira-actions-bottom {
      margin-top: 16px;
    }

    body.model-post.change-form .oxira-actions-bottom .card {
      border-radius: 16px !important;
      border: 1px solid rgba(0,0,0,.06) !important;
      box-shadow: 0 10px 28px rgba(0,0,0,.04) !important;
    }

    body.model-post.change-form .oxira-actions-bottom .btn {
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      padding: 12px 14px;
    }

    /* Painel lateral (substitui os botões padrão do Jazzmin) */
    body.model-post.change-form #jazzy-actions {
      position: sticky;
      top: 12px;
    }


    body.model-post.change-form .oxira-sidepanel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body.model-post.change-form .oxira-sidecard {
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.06);
      background: #fff;
      box-shadow: 0 10px 28px rgba(0,0,0,.04);
      padding: 14px;
    }

    body.model-post.change-form .oxira-sidecard h3 {
      font-size: 13px;
      font-weight: 950;
      margin: 0 0 8px 0;
      color: rgba(17,24,39,.92);
    }

    body.model-post.change-form .oxira-sidecard .muted {
      color: rgba(107,114,128,.95);
      font-size: 12px;
    }

    body.model-post.change-form .oxira-sidecard ul {
      margin: 10px 0 0 0;
      padding-left: 18px;
    }

    body.model-post.change-form .oxira-sidecard li {
      margin: 6px 0;
      color: rgba(31,41,55,.92);
      font-size: 12px;
    }

    /* Checklist com check automático */
    body.model-post.change-form .oxira-checklist {
      list-style: none;
      padding-left: 0;
      margin: 10px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    body.model-post.change-form .oxira-checklist li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin: 0;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.9);
    }

    body.model-post.change-form .oxira-check {
      width: 18px;
      height: 18px;
      flex: 0 0 18px;
      border-radius: 999px;
      border: 1px solid rgba(107,114,128,.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 950;
      font-size: 12px;
      line-height: 1;
      color: rgba(107,114,128,.9);
      margin-top: 1px;
      background: #fff;
    }

    body.model-post.change-form .oxira-checklist li.is-done {
      border-color: rgba(34,197,94,.25);
      background: rgba(34,197,94,.06);
    }

    body.model-post.change-form .oxira-checklist li.is-done .oxira-check {
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.12);
      color: rgba(22,163,74,1);
    }

    body.model-post.change-form .oxira-check-text {
      flex: 1 1 auto;
    }

    body.model-post.change-form .oxira-check-title {
      font-weight: 900;
      color: rgba(17,24,39,.92);
    }

    body.model-post.change-form .oxira-check-desc {
      margin-top: 2px;
      color: rgba(107,114,128,.95);
      font-size: 12px;
    }
  </style>
{% endblock %}

{% block form_top %}
  {{ block.super }}

  <div style="display:flex;justify-content:flex-end;gap:10px;margin:0 0 12px 0;">
    <button
      type="button"
      class="btn btn-outline-primary"
      id="oxira-preview-btn"
      data-endpoint="{% url 'post_preview_draft_set' %}"
      style="border-radius:12px;font-weight:900;"
    >Visualizar no site</button>
  </div>

  {% if adminform.form.errors %}
    <div class="oxira-modal-backdrop" id="oxira-error-backdrop" role="dialog" aria-modal="true" aria-labelledby="oxira-error-title">
      <div class="oxira-modal" role="document">
        <div class="oxira-modal-header">
          <h2 class="oxira-modal-title" id="oxira-error-title">
            <span class="badge">!</span>
            Não foi possível salvar
          </h2>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="oxira-error-close" aria-label="Fechar">Fechar</button>
        </div>
        <div class="oxira-modal-body">
          <div class="muted">Corrija os campos abaixo e tente salvar novamente.</div>

          <ul class="oxira-error-list">
            {% if adminform.form.non_field_errors %}
              <li class="oxira-error-item">
                <strong>Geral</strong>
                {{ adminform.form.non_field_errors }}
              </li>
            {% endif %}

            {% for field in adminform.form %}
              {% if field.errors %}
                <li class="oxira-error-item">
                  <strong>{{ field.label|default:field.name }}</strong>
                  {{ field.errors }}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
        <div class="oxira-modal-footer">
          <button type="button" class="btn btn-primary" id="oxira-error-ok">Entendi</button>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{# Mantém o layout do Jazzmin (9 + 3 colunas) e coloca os botões NO FINAL da coluna principal #}
{% block field_sets %}
  <div class="col-12 col-lg-9">
    <div class="card">
      <div class="card-body">
        {% get_changeform_template adminform as changeform_template %}
        {% include changeform_template %}
      </div>
    </div>

    <div class="oxira-actions-bottom">
      <div class="card">
        <div class="card-body" style="display:flex;flex-direction:column;gap:10px;">
          <button type="submit" name="_save" class="btn btn-success btn-block">Salvar</button>
          <button type="submit" name="_save_draft" class="btn btn-warning btn-block">Salvar nos rascunhos</button>
          <a href="{% url opts|admin_urlname:'changelist' %}" class="btn btn-outline-secondary btn-block">Cancelar</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{# Substitui os botões padrão na lateral direita por um painel útil #}
{% block submit_buttons_bottom %}
  <div class="oxira-sidepanel">
    <div class="oxira-sidecard">
      <h3>Checklist rápido</h3>
      <div class="muted">Antes de publicar, confere isso aqui.</div>

      <ul class="oxira-checklist" id="oxira-checklist">
        <li data-check="title">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">Título preenchido</div>
            <div class="oxira-check-desc">Claro e direto (benefício + contexto).</div>
          </span>
        </li>
        <li data-check="subtitle">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">Subtítulo preenchido</div>
            <div class="oxira-check-desc">Uma frase com promessa/gancho.</div>
          </span>
        </li>
        <li data-check="content">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">Conteúdo começou</div>
            <div class="oxira-check-desc">Pelo menos um parágrafo (texto suficiente).</div>
          </span>
        </li>
        <li data-check="image">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">Imagem destacada</div>
            <div class="oxira-check-desc">Preferência 16:9 (1280×720).</div>
          </span>
        </li>
        <li data-check="category">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">Categoria selecionada</div>
            <div class="oxira-check-desc">Canal correto (organiza o site).</div>
          </span>
        </li>
        <li data-check="published_date">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">Data de publicação definida</div>
            <div class="oxira-check-desc">Importante para agendar e ordenar na home.</div>
          </span>
        </li>
        <li data-check="seo">
          <span class="oxira-check" aria-hidden="true">○</span>
          <span class="oxira-check-text">
            <div class="oxira-check-title">SEO preenchido</div>
            <div class="oxira-check-desc">Meta descrição + keywords.</div>
          </span>
        </li>
      </ul>

      {% if change and not is_popup %}
        <hr style="border:0;border-top:1px solid rgba(0,0,0,.06);margin:12px 0;">
        <h3>Ferramentas</h3>
        <div class="muted" style="margin-bottom:8px;">Ações úteis desse post.</div>
        <div class="object-tools" style="margin:0;">
          {% change_form_object_tools %}
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{# Não injeta nada aqui para não quebrar o grid (a lateral deve ficar em cima) #}
{% block after_related_objects %}{{ block.super }}{% endblock %}

{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>
    (function () {
      // Remove/oculta o alerta padrão de erro do admin (faixa vermelha no topo)
      // para deixar somente o popup de validação.
      try {
        const needles = [
          'please correct the errors below',
          'por favor',
          'corrija os erros',
        ];
        document.querySelectorAll('.alert.alert-danger, .errornote').forEach(function (el) {
          const text = (el.textContent || '').toLowerCase();
          if (!text) return;
          if (needles.some(function (n) { return text.includes(n); })) {
            el.style.display = 'none';
          }
        });
      } catch (e) {}

      // Preview: sempre disponível, mesmo sem salvar.
      function getCSRF() {
        const el = document.querySelector('input[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
      }

      function getEditorHtml() {
        try {
          if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances.id_content) {
            return CKEDITOR.instances.id_content.getData() || '';
          }
        } catch (e) {}
        const el = document.getElementById('id_content');
        return el ? (el.value || '') : '';
      }

      function getPublishedDate() {
        const d0 = document.getElementById('id_published_date_0');
        const d1 = document.getElementById('id_published_date_1');
        if (d0 && d1) {
          const a = (d0.value || '').trim();
          const b = (d1.value || '').trim();
          return (a || b) ? (a + ' ' + b).trim() : '';
        }
        const d = document.getElementById('id_published_date');
        return d ? (d.value || '') : '';
      }

      async function openPreview() {
        const btn = document.getElementById('oxira-preview-btn');
        if (!btn) return;
        const endpoint = btn.getAttribute('data-endpoint');
        if (!endpoint) return;

        // Abre imediatamente para evitar bloqueio de popup
        const win = window.open('about:blank', '_blank');
        if (!win) {
          alert('Seu navegador bloqueou o popup. Permita popups para o admin.');
          return;
        }

        const body = new URLSearchParams();
        body.set('title', (document.getElementById('id_title')?.value || '').trim());
        body.set('subtitle', (document.getElementById('id_subtitle')?.value || '').trim());
        body.set('content', getEditorHtml());
        body.set('meta_description', (document.getElementById('id_meta_description')?.value || '').trim());
        body.set('keywords', (document.getElementById('id_keywords')?.value || '').trim());
        body.set('status', (document.getElementById('id_status')?.value || '').trim());
        body.set('published_date', getPublishedDate());
        body.set('author_id', (document.getElementById('id_author')?.value || '').trim());
        body.set('category_id', (document.getElementById('id_category')?.value || '').trim());

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
              'X-CSRFToken': getCSRF(),
            },
            body: body.toString(),
            credentials: 'same-origin',
          });
          const data = await res.json().catch(function () { return null; });
          if (!res.ok || !data || !data.ok || !data.url) {
            win.close();
            alert((data && data.error) ? data.error : ('Falha ao gerar preview (HTTP ' + res.status + ').'));
            return;
          }
          win.location.href = data.url;
        } catch (e) {
          win.close();
          alert('Falha ao gerar preview.');
        }
      }

      const previewBtn = document.getElementById('oxira-preview-btn');
      if (previewBtn) {
        previewBtn.addEventListener('click', function () {
          openPreview();
        });
      }

      const backdrop = document.getElementById('oxira-error-backdrop');
      if (!backdrop) return;

      function close() {
        backdrop.style.display = 'none';
        document.body.style.overflow = '';
      }

      function open() {
        backdrop.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      const closeBtn = document.getElementById('oxira-error-close');
      const okBtn = document.getElementById('oxira-error-ok');
      if (closeBtn) closeBtn.addEventListener('click', close);
      if (okBtn) okBtn.addEventListener('click', close);

      backdrop.addEventListener('click', function (e) {
        if (e.target === backdrop) close();
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') close();
      });

      // Abre automaticamente quando houver erros no form
      open();
    })();
  </script>
  <script>
    (function () {
      const tips = {
        title: "Aqui vai o seu TÍTULO (o grandão). Aparece na home/lista e lá em cima na matéria. Ex: \"IA no Varejo: como as lojas estão virando laboratório\". Capricha: é a primeira coisa que o povo vê.",
        subtitle: "SUBTÍTULO é o teaser: uma frase curtinha pra dar contexto e vontade de clicar. Ex: \"Do caixa ao estoque, a tecnologia está mudando tudo — e rápido.\"",
        slug: "SLUG é o endereço da matéria (URL). Ele vira o link. Ex: \"ia-no-varejo-tecnologia-personalizando\". Dica: sem acento, sem espaços, tudo com hífen.",
        author: "AUTOR é quem assina a matéria. Vai aparecer perto do título e também na página do perfil do autor. Normalmente já vem como você (e só admin consegue trocar).",
        content: "CONTEÚDO é o texto da matéria (o que a pessoa vai ler). Aqui vale: subtítulo, intertítulos, links e imagens. Pense: \"começo forte\", \"meio com dados\", \"final com conclusão\".",
        image: "IMAGEM DESTACADA é a capa da matéria (upload). Ela aparece na home/listas e no topo da matéria. Tamanho recomendado: 1280×720 (16:9). Use JPG/WEBP e evite imagem pequena pra não pixelar.",
        category: "CATEGORIA é o canal da matéria (Esportes, Política...). Ela aparece como etiqueta perto do título e organiza o site.",
        status: "STATUS controla se a matéria aparece no site. \n• Rascunho: só você vê.\n• Em revisão: pra ajustar antes de publicar.\n• Publicado: no ar.\n• Agendado: publica na data/hora escolhida.",
        published_date: "DATA DE PUBLICAÇÃO é quando a matéria deve entrar no ar (ou aparecer como publicada). Ex: agendar pra amanhã 08:00 pra já deixar pronto.",
        internal_notes: "OBSERVAÇÕES INTERNAS é bastidor (não vai pro público). Use pra pauta, links de referência, checklist, 'falar com fulano', etc.",
        meta_description: "META DESCRIÇÃO (SEO) é o textinho que pode aparecer no Google e quando compartilha link. Ex: \"Entenda como IA está mudando o varejo e o que isso significa pra preços e empregos.\"",
        keywords: "PALAVRAS-CHAVE (SEO) são tags separadas por vírgula. Ex: \"inteligência artificial, varejo, tecnologia, consumo\". Sem exagero: 5 a 10 tá ótimo."
      };

      function addHelp(labelEl, text) {
        if (!labelEl) return;
        if (labelEl.querySelector('.oxira-help')) return;
        const span = document.createElement('span');
        span.className = 'oxira-help';
        span.setAttribute('data-tip', text);
        span.textContent = '?';
        labelEl.appendChild(span);
      }

      function findLabel(fieldName) {
        // Tenta achar label para widgets normais e para SplitDateTime (id_published_date_0)
        const exact = document.querySelector('label[for="id_' + fieldName + '"]');
        if (exact) return exact;
        const starts = document.querySelector('label[for^="id_' + fieldName + '"]');
        if (starts) return starts;
        return null;
      }

      Object.keys(tips).forEach(function (k) {
        addHelp(findLabel(k), tips[k]);
      });

      // Placeholders simpáticos
      const title = document.getElementById('id_title');
      if (title && !title.placeholder) title.placeholder = 'Ex: Nova lei de zoneamento: o que muda na sua cidade';

      const subtitle = document.getElementById('id_subtitle');
      if (subtitle && !subtitle.placeholder) subtitle.placeholder = 'Ex: Entenda em 3 pontos e sem juridiquês';

      const meta = document.getElementById('id_meta_description');
      if (meta && !meta.placeholder) meta.placeholder = 'Ex: Resumo curto e chamativo (até ~160 caracteres)';

      const kw = document.getElementById('id_keywords');
      if (kw && !kw.placeholder) kw.placeholder = 'Ex: política, zoneamento, congresso, cidades';

      const notes = document.getElementById('id_internal_notes');
      if (notes && !notes.placeholder) notes.placeholder = 'Bastidores: links, pauta, checklist, fontes…';
    })();
  </script>

  <script>
    (function () {
      function trim(v) {
        return (v || '').toString().trim();
      }

      function getValue(id) {
        const el = document.getElementById(id);
        return el ? trim(el.value) : '';
      }

      function getContentTextLength() {
        // Tenta CKEditor; fallback textarea
        let html = '';
        try {
          if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances.id_content) {
            html = CKEDITOR.instances.id_content.getData() || '';
          }
        } catch (e) {}
        if (!html) {
          const el = document.getElementById('id_content');
          html = el ? (el.value || '') : '';
        }
        const text = html
          .replace(/<style[\s\S]*?<\/style>/gi, ' ')
          .replace(/<script[\s\S]*?<\/script>/gi, ' ')
          .replace(/<[^>]+>/g, ' ')
          .replace(/&nbsp;/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
        return text.length;
      }

      function hasFeaturedImage() {
        // Se já existe imagem, Django mostra link "Currently"
        const hasCurrent = !!document.querySelector('.field-image a');

        // Se usuário selecionou arquivo
        const file = document.getElementById('id_image');
        const hasNew = !!(file && file.files && file.files.length);

        // Se marcou para limpar, não conta
        const clear = document.getElementById('image-clear_id');
        const willClear = !!(clear && clear.checked);

        return !willClear && (hasNew || hasCurrent);
      }

      function hasPublishedDate() {
        // SplitDateTimeWidget costuma ser id_published_date_0 e _1
        const d0 = document.getElementById('id_published_date_0');
        const d1 = document.getElementById('id_published_date_1');
        if (d0 || d1) {
          const v0 = d0 ? trim(d0.value) : '';
          const v1 = d1 ? trim(d1.value) : '';
          return !!(v0 && v1);
        }
        // Fallback: input datetime-local
        const single = document.getElementById('id_published_date');
        return !!(single && trim(single.value));
      }

      function hasSEO() {
        const meta = getValue('id_meta_description');
        const kw = getValue('id_keywords');
        return meta.length >= 30 && kw.length >= 10;
      }

      function setDone(li, done) {
        if (!li) return;
        const badge = li.querySelector('.oxira-check');
        if (done) {
          li.classList.add('is-done');
          if (badge) badge.textContent = '✓';
        } else {
          li.classList.remove('is-done');
          if (badge) badge.textContent = '○';
        }
      }

      function updateChecklist() {
        const root = document.getElementById('oxira-checklist');
        if (!root) return;

        const titleOk = getValue('id_title').length > 3;
        const subtitleOk = getValue('id_subtitle').length > 10;
        const contentOk = getContentTextLength() >= 180;
        const imageOk = hasFeaturedImage();
        const categoryOk = getValue('id_category') !== '';
        const dateOk = hasPublishedDate();
        const seoOk = hasSEO();

        setDone(root.querySelector('li[data-check="title"]'), titleOk);
        setDone(root.querySelector('li[data-check="subtitle"]'), subtitleOk);
        setDone(root.querySelector('li[data-check="content"]'), contentOk);
        setDone(root.querySelector('li[data-check="image"]'), imageOk);
        setDone(root.querySelector('li[data-check="category"]'), categoryOk);
        setDone(root.querySelector('li[data-check="published_date"]'), dateOk);
        setDone(root.querySelector('li[data-check="seo"]'), seoOk);
      }

      function bindEvents() {
        const ids = [
          'id_title',
          'id_subtitle',
          'id_category',
          'id_meta_description',
          'id_keywords',
          'id_published_date_0',
          'id_published_date_1',
          'id_published_date',
          'id_image',
          'image-clear_id'
        ];
        ids.forEach(function (id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('input', updateChecklist);
          el.addEventListener('change', updateChecklist);
        });

        // CKEditor muda fora do input padrão
        try {
          if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances.id_content) {
            CKEDITOR.instances.id_content.on('change', updateChecklist);
            CKEDITOR.instances.id_content.on('key', updateChecklist);
          }
        } catch (e) {}
      }

      // Primeiro paint e um retry (caso CKEditor demore)
      updateChecklist();
      bindEvents();
      setTimeout(function () {
        bindEvents();
        updateChecklist();
      }, 800);
    })();
  </script>
{% endblock %}
