{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify jazzmin %}

{% block breadcrumbs %}{% endblock %}
{% block nav-breadcrumbs %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* Página do Post: limpa o topo (breadcrumbs) e dá um ar mais "editor" */
    body.model-post.change-form .content-header,
    body.model-post.change-form .breadcrumb,
    body.model-post.change-form .breadcrumbs {
      display: none !important;
    }

    body.model-post.change-form #content {
      padding-top: 14px;
    }

    .oxira-editor-tip {
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(220,38,38,.04);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 14px;
    }
    .oxira-editor-tip strong { font-weight: 900; }
    .oxira-editor-tip .muted { color: rgba(107,114,128,.95); }

    /* Tooltip "?" (mesmo estilo do dashboard) */
    .oxira-help {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid rgba(107, 114, 128, .35);
      color: rgba(107, 114, 128, .95);
      font-weight: 900;
      font-size: 10px;
      line-height: 1;
      cursor: help;
      user-select: none;
      position: relative;
      top: -1px;
      z-index: 9999;
    }

    .oxira-help:hover {
      border-color: rgba(220, 38, 38, .55);
      color: rgba(220, 38, 38, 1);
      background: rgba(220, 38, 38, .08);
    }

    .oxira-help[data-tip]::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translate(-50%, -100%);
      background: rgba(255, 255, 255, .98);
      color: rgba(17, 24, 39, .96);
      border: 1px solid rgba(0,0,0,.08);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 650;
      letter-spacing: 0;
      text-transform: none;
      width: max-content;
      max-width: 360px;
      white-space: normal;
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease;
      z-index: 100000;
    }

    .oxira-help[data-tip]::before {
      content: "";
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translate(-50%, -2px);
      border: 6px solid transparent;
      border-top-color: rgba(255, 255, 255, .98);
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.06));
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease;
      z-index: 100001;
    }

    .oxira-help:hover::after,
    .oxira-help:hover::before {
      opacity: 1;
    }

    /* Evita o tooltip ser cortado por containers com overflow */
    body.model-post.change-form .card,
    body.model-post.change-form .module,
    body.model-post.change-form fieldset.module {
      overflow: visible !important;
    }

    /* Deixa labels mais “editor” */
    body.model-post.change-form label {
      font-weight: 800;
    }

    /* ===== Visual clean/moderno (apenas Post) ===== */
    body.model-post.change-form .oxira-editor-tip {
      background: #fff;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 8px 24px rgba(0,0,0,.04);
    }

    /* Cards/fieldsets mais leves */
    body.model-post.change-form .card,
    body.model-post.change-form .module,
    body.model-post.change-form fieldset.module {
      border-radius: 16px !important;
      border: 1px solid rgba(0,0,0,.06) !important;
      box-shadow: 0 10px 28px rgba(0,0,0,.04) !important;
      overflow: hidden;
    }

    body.model-post.change-form .card-header,
    body.model-post.change-form .module h2,
    body.model-post.change-form fieldset.module > h2 {
      border-bottom: 1px solid rgba(0,0,0,.06) !important;
      background: #fff !important;
    }

    /* Mata aquele “gradeado”/linhas entre campos */
    body.model-post.change-form .form-row {
      border-bottom: 0 !important;
      padding-bottom: 0 !important;
      margin-bottom: 14px !important;
    }

    /* Layout: label em cima do campo, tudo mais compacto */
    body.model-post.change-form .aligned .form-row,
    body.model-post.change-form .form-row {
      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 6px;
    }

    body.model-post.change-form .form-row > div,
    body.model-post.change-form .form-row .fieldBox,
    body.model-post.change-form .form-row .flex-container {
      float: none !important;
      width: 100% !important;
      max-width: 100% !important;
    }

    body.model-post.change-form label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: rgba(17, 24, 39, .92);
      margin: 0 !important;
      padding: 0 !important;
    }

    body.model-post.change-form .help,
    body.model-post.change-form .helptext,
    body.model-post.change-form .form-row .help,
    body.model-post.change-form .form-row .helptext {
      margin-top: 6px !important;
      color: rgba(107,114,128,.95) !important;
      font-size: 12px !important;
    }

    /* Inputs modernos */
    body.model-post.change-form input[type="text"],
    body.model-post.change-form input[type="number"],
    body.model-post.change-form input[type="url"],
    body.model-post.change-form input[type="email"],
    body.model-post.change-form input[type="search"],
    body.model-post.change-form input[type="datetime-local"],
    body.model-post.change-form input.vTextField,
    body.model-post.change-form select,
    body.model-post.change-form textarea {
      width: 100% !important;
      max-width: 100% !important;
      padding: 12px 14px !important;
      border-radius: 12px !important;
      border: 1px solid rgba(0,0,0,.12) !important;
      background: #fff !important;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    body.model-post.change-form input::placeholder,
    body.model-post.change-form textarea::placeholder {
      color: rgba(156,163,175,.95);
    }

    body.model-post.change-form input[type="text"]:focus,
    body.model-post.change-form input[type="number"]:focus,
    body.model-post.change-form input[type="url"]:focus,
    body.model-post.change-form input[type="email"]:focus,
    body.model-post.change-form input[type="search"]:focus,
    body.model-post.change-form input[type="datetime-local"]:focus,
    body.model-post.change-form input.vTextField:focus,
    body.model-post.change-form select:focus,
    body.model-post.change-form textarea:focus {
      outline: none !important;
      border-color: rgba(220,38,38,.65) !important;
      box-shadow: 0 0 0 4px rgba(220,38,38,.12) !important;
    }

    /* raw_id_fields (Autor) mais amigável */
    body.model-post.change-form .related-widget-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
    }
    body.model-post.change-form .related-widget-wrapper input {
      flex: 1 1 220px;
      min-width: 180px;
    }
    body.model-post.change-form .related-widget-wrapper a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      color: rgba(17,24,39,.9);
      font-weight: 800;
      text-decoration: none;
    }
    body.model-post.change-form .related-widget-wrapper a:hover {
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.05);
      color: rgba(220,38,38,1);
    }

    /* CKEditor: borda/raio alinhados ao resto */
    body.model-post.change-form .cke {
      border-radius: 16px !important;
      border: 1px solid rgba(0,0,0,.10) !important;
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,.04) !important;
    }
    body.model-post.change-form .cke_top {
      background: #fff !important;
      border-bottom: 1px solid rgba(0,0,0,.06) !important;
    }
    body.model-post.change-form .cke_contents {
      background: #fff !important;
    }

    /* Mobile: deixa o editor utilizável (de quebra-galho) */
    @media (max-width: 640px) {
      /* Evita "scroll duplo" e cortes horizontais */
      body.model-post.change-form #content {
        padding-left: 12px;
        padding-right: 12px;
      }

      /* Campos e widgets sempre 100% */
      body.model-post.change-form .form-row,
      body.model-post.change-form .aligned,
      body.model-post.change-form .fieldBox,
      body.model-post.change-form .form-row .fieldBox,
      body.model-post.change-form .form-row .flex-container,
      body.model-post.change-form .form-row input,
      body.model-post.change-form .form-row select,
      body.model-post.change-form .form-row textarea {
        max-width: 100% !important;
      }

      /* CKEditor: container 100% */
      body.model-post.change-form .django-ckeditor-widget,
      body.model-post.change-form .cke,
      body.model-post.change-form .cke_inner,
      body.model-post.change-form .cke_contents,
      body.model-post.change-form .cke_contents iframe {
        width: 100% !important;
        max-width: 100% !important;
      }

      /* CKEditor: toolbar quebra linha e botões maiores */
      body.model-post.change-form .cke_top {
        padding: 8px 8px 6px !important;
      }
      body.model-post.change-form .cke_toolbox {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 6px 8px !important;
      }
      body.model-post.change-form .cke_toolbar {
        float: none !important;
        margin: 0 !important;
      }
      body.model-post.change-form .cke_combo,
      body.model-post.change-form .cke_toolbar_group {
        margin: 0 !important;
      }
      body.model-post.change-form .cke_button,
      body.model-post.change-form .cke_combo_button {
        padding: 7px 8px !important;
      }
      body.model-post.change-form .cke_button_icon {
        transform: scale(1.05);
      }

      /* Área de edição com altura boa no mobile */
      body.model-post.change-form .cke_contents {
        min-height: 360px !important;
      }

      /* Tooltips: não estoura na tela pequena */
      .oxira-help[data-tip]::after {
        max-width: min(320px, calc(100vw - 24px));
      }
    }

    /* ===== Ações no rodapé (em vez de lateral) ===== */
    body.model-post.change-form .oxira-actions-bottom {
      margin-top: 16px;
    }

    body.model-post.change-form .oxira-actions-bottom .card {
      border-radius: 16px !important;
      border: 1px solid rgba(0,0,0,.06) !important;
      box-shadow: 0 10px 28px rgba(0,0,0,.04) !important;
    }

    body.model-post.change-form .oxira-actions-bottom .btn {
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      padding: 12px 14px;
    }

    /* Painel lateral (substitui os botões padrão do Jazzmin) */
    body.model-post.change-form #jazzy-actions {
      position: sticky;
      top: 12px;
    }

    body.model-post.change-form .oxira-sidepanel {
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.06);
      background: #fff;
      box-shadow: 0 10px 28px rgba(0,0,0,.04);
      padding: 14px;
    }

    body.model-post.change-form .oxira-sidepanel h3 {
      font-size: 13px;
      font-weight: 950;
      margin: 0 0 8px 0;
      color: rgba(17,24,39,.92);
    }

    body.model-post.change-form .oxira-sidepanel .muted {
      color: rgba(107,114,128,.95);
      font-size: 12px;
    }

    body.model-post.change-form .oxira-sidepanel ul {
      margin: 10px 0 0 0;
      padding-left: 18px;
    }

    body.model-post.change-form .oxira-sidepanel li {
      margin: 6px 0;
      color: rgba(31,41,55,.92);
      font-size: 12px;
    }
  </style>
{% endblock %}

{% block form_top %}
  <div class="oxira-editor-tip">
    <strong>Hora de escrever.</strong>
    <span class="muted">Dica rápida: título chama clique, subtítulo segura o leitor e conteúdo entrega a promessa (sem enrolação, claro).</span>
  </div>
  {{ block.super }}
{% endblock %}

{# Substitui os botões padrão na lateral direita por um painel útil #}
{% block submit_buttons_bottom %}
  <div class="oxira-sidepanel">
    <h3>Assistente IA</h3>
    <div class="muted">Sugestões rápidas sem sair do editor (usa o conteúdo atual).</div>

    <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
      <textarea id="oxira-ai-angle" rows="2" placeholder="Ângulo/objetivo (opcional). Ex: foco em serviço, sem opinião…" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.12);"></textarea>

      <button type="button" class="btn btn-outline-primary btn-block oxira-ai-btn" data-action="titles" data-endpoint="{% url 'admin:blog_post_ai_assistant' %}">Sugerir 10 títulos</button>
      <button type="button" class="btn btn-outline-primary btn-block oxira-ai-btn" data-action="subtitles" data-endpoint="{% url 'admin:blog_post_ai_assistant' %}">Sugerir subtítulos</button>
      <button type="button" class="btn btn-outline-primary btn-block oxira-ai-btn" data-action="lead" data-endpoint="{% url 'admin:blog_post_ai_assistant' %}">Criar lead</button>
      <button type="button" class="btn btn-outline-primary btn-block oxira-ai-btn" data-action="seo" data-endpoint="{% url 'admin:blog_post_ai_assistant' %}">SEO (meta + keywords)</button>
    </div>

    <div id="oxira-ai-status" class="muted" style="margin-top:10px;display:none;"></div>
    <div id="oxira-ai-result" style="margin-top:10px;display:none;"></div>

    <hr style="border:0;border-top:1px solid rgba(0,0,0,.06);margin:14px 0;">

    <h3>Checklist rápido</h3>
    <div class="muted">Antes de publicar, confere isso aqui.</div>
    <ul>
      <li>Título claro (benefício + contexto)</li>
      <li>Subtítulo com promessa (1 frase)</li>
      <li>Imagem destacada 16:9 (1280×720)</li>
      <li>Categoria correta</li>
      <li>Status e data de publicação ok</li>
      <li>Meta descrição pronta (SEO)</li>
    </ul>

    {% if change and not is_popup %}
      <hr style="border:0;border-top:1px solid rgba(0,0,0,.06);margin:12px 0;">
      <h3>Ferramentas</h3>
      <div class="muted" style="margin-bottom:8px;">Ações úteis desse post.</div>
      <div class="object-tools" style="margin:0;">
        {% change_form_object_tools %}
      </div>
    {% endif %}
  </div>
{% endblock %}

{# Botões no final da página, um abaixo do outro #}
{% block after_related_objects %}
  {{ block.super }}
  <div class="col-12 oxira-actions-bottom">
    <div class="card">
      <div class="card-body" style="display:flex;flex-direction:column;gap:10px;">
        <button type="submit" name="_save" class="btn btn-success btn-block">Salvar</button>
        <button type="submit" name="_save_draft" class="btn btn-warning btn-block">Salvar nos rascunhos</button>
        <a href="{% url opts|admin_urlname:'changelist' %}" class="btn btn-outline-secondary btn-block">Cancelar</a>
      </div>
    </div>
  </div>
{% endblock %}

{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>
    (function () {
      const tips = {
        title: "Aqui vai o seu TÍTULO (o grandão). Aparece na home/lista e lá em cima na matéria. Ex: \"IA no Varejo: como as lojas estão virando laboratório\". Capricha: é a primeira coisa que o povo vê.",
        subtitle: "SUBTÍTULO é o teaser: uma frase curtinha pra dar contexto e vontade de clicar. Ex: \"Do caixa ao estoque, a tecnologia está mudando tudo — e rápido.\"",
        slug: "SLUG é o endereço da matéria (URL). Ele vira o link. Ex: \"ia-no-varejo-tecnologia-personalizando\". Dica: sem acento, sem espaços, tudo com hífen.",
        author: "AUTOR é quem assina a matéria. Vai aparecer perto do título e também na página do perfil do autor. Normalmente já vem como você (e só admin consegue trocar).",
        content: "CONTEÚDO é o texto da matéria (o que a pessoa vai ler). Aqui vale: subtítulo, intertítulos, links e imagens. Pense: \"começo forte\", \"meio com dados\", \"final com conclusão\".",
        image: "IMAGEM DESTACADA é a capa da matéria (upload). Ela aparece na home/listas e no topo da matéria. Tamanho recomendado: 1280×720 (16:9). Use JPG/WEBP e evite imagem pequena pra não pixelar.",
        category: "CATEGORIA é o canal da matéria (Esportes, Política...). Ela aparece como etiqueta perto do título e organiza o site.",
        status: "STATUS controla se a matéria aparece no site. \n• Rascunho: só você vê.\n• Em revisão: pra ajustar antes de publicar.\n• Publicado: no ar.\n• Agendado: publica na data/hora escolhida.",
        published_date: "DATA DE PUBLICAÇÃO é quando a matéria deve entrar no ar (ou aparecer como publicada). Ex: agendar pra amanhã 08:00 pra já deixar pronto.",
        internal_notes: "OBSERVAÇÕES INTERNAS é bastidor (não vai pro público). Use pra pauta, links de referência, checklist, 'falar com fulano', etc.",
        meta_description: "META DESCRIÇÃO (SEO) é o textinho que pode aparecer no Google e quando compartilha link. Ex: \"Entenda como IA está mudando o varejo e o que isso significa pra preços e empregos.\"",
        keywords: "PALAVRAS-CHAVE (SEO) são tags separadas por vírgula. Ex: \"inteligência artificial, varejo, tecnologia, consumo\". Sem exagero: 5 a 10 tá ótimo."
      };

      function addHelp(labelEl, text) {
        if (!labelEl) return;
        if (labelEl.querySelector('.oxira-help')) return;
        const span = document.createElement('span');
        span.className = 'oxira-help';
        span.setAttribute('data-tip', text);
        span.textContent = '?';
        labelEl.appendChild(span);
      }

      function findLabel(fieldName) {
        // Tenta achar label para widgets normais e para SplitDateTime (id_published_date_0)
        const exact = document.querySelector('label[for="id_' + fieldName + '"]');
        if (exact) return exact;
        const starts = document.querySelector('label[for^="id_' + fieldName + '"]');
        if (starts) return starts;
        return null;
      }

      Object.keys(tips).forEach(function (k) {
        addHelp(findLabel(k), tips[k]);
      });

      // Placeholders simpáticos
      const title = document.getElementById('id_title');
      if (title && !title.placeholder) title.placeholder = 'Ex: Nova lei de zoneamento: o que muda na sua cidade';

      const subtitle = document.getElementById('id_subtitle');
      if (subtitle && !subtitle.placeholder) subtitle.placeholder = 'Ex: Entenda em 3 pontos e sem juridiquês';

      const meta = document.getElementById('id_meta_description');
      if (meta && !meta.placeholder) meta.placeholder = 'Ex: Resumo curto e chamativo (até ~160 caracteres)';

      const kw = document.getElementById('id_keywords');
      if (kw && !kw.placeholder) kw.placeholder = 'Ex: política, zoneamento, congresso, cidades';

      const notes = document.getElementById('id_internal_notes');
      if (notes && !notes.placeholder) notes.placeholder = 'Bastidores: links, pauta, checklist, fontes…';
    })();
  </script>

  <script>
    (function () {
      function getCSRF() {
        const el = document.querySelector('input[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
      }

      function getEditorHtml() {
        try {
          if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances.id_content) {
            return CKEDITOR.instances.id_content.getData() || '';
          }
        } catch (e) {}
        const el = document.getElementById('id_content');
        return el ? (el.value || '') : '';
      }

      function setFieldValue(fieldId, value) {
        const el = document.getElementById(fieldId);
        if (!el) return;
        el.value = value;
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
      }

      function escapeHtml(s) {
        return (s || '').replace(/[&<>"']/g, function (c) {
          return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c];
        });
      }

      function parseBullets(text) {
        const lines = (text || '').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        const bullets = lines
          .filter(l => l.startsWith('- '))
          .map(l => l.replace(/^\-\s+/, '').trim())
          .filter(Boolean);
        return bullets.length ? bullets : null;
      }

      function renderResult(action, text) {
        const container = document.getElementById('oxira-ai-result');
        if (!container) return;

        const bullets = parseBullets(text);
        if (bullets) {
          const targetField = action === 'titles' ? 'id_title' : (action === 'subtitles' ? 'id_subtitle' : null);
          const label = action === 'titles' ? 'Usar no título' : 'Usar no subtítulo';

          container.innerHTML = [
            '<div style="display:flex;flex-direction:column;gap:10px;">',
            bullets.map(function (b) {
              return (
                '<div style="border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;box-shadow:0 8px 18px rgba(0,0,0,.04);">' +
                  '<div style="font-weight:850;color:rgba(17,24,39,.92);font-size:12px;margin-bottom:8px;">' + escapeHtml(b) + '</div>' +
                  (targetField ? '<button type="button" class="btn btn-sm btn-success btn-block oxira-ai-apply" data-target="' + targetField + '" data-value="' + escapeHtml(b) + '">' + label + '</button>' : '') +
                '</div>'
              );
            }).join(''),
            '</div>'
          ].join('');

          container.style.display = 'block';
          return;
        }

        // SEO: meta + keywords
        if (action === 'seo') {
          const metaMatch = (text || '').match(/^Meta:\s*(.*)$/mi);
          const kwMatch = (text || '').match(/^Keywords:\s*(.*)$/mi);
          const meta = metaMatch ? metaMatch[1].trim() : '';
          const kw = kwMatch ? kwMatch[1].trim() : '';

          container.innerHTML = (
            '<div style="display:flex;flex-direction:column;gap:10px;">' +
              '<div style="border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;">' +
                '<div class="muted" style="margin-bottom:6px;">Meta descrição</div>' +
                '<div style="font-weight:850;font-size:12px;">' + escapeHtml(meta || text) + '</div>' +
                (meta ? '<button type="button" class="btn btn-sm btn-success btn-block oxira-ai-apply" data-target="id_meta_description" data-value="' + escapeHtml(meta) + '">Aplicar no campo</button>' : '') +
              '</div>' +
              '<div style="border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;">' +
                '<div class="muted" style="margin-bottom:6px;">Keywords</div>' +
                '<div style="font-weight:850;font-size:12px;">' + escapeHtml(kw) + '</div>' +
                (kw ? '<button type="button" class="btn btn-sm btn-success btn-block oxira-ai-apply" data-target="id_keywords" data-value="' + escapeHtml(kw) + '">Aplicar no campo</button>' : '') +
              '</div>' +
            '</div>'
          );
          container.style.display = 'block';
          return;
        }

        // Lead / fallback
        container.innerHTML = (
          '<div style="border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;">' +
            '<div style="white-space:pre-wrap;font-weight:750;font-size:12px;color:rgba(17,24,39,.92);">' + escapeHtml(text) + '</div>' +
            '<button type="button" class="btn btn-sm btn-success btn-block" id="oxira-ai-copy">Copiar</button>' +
          '</div>'
        );
        container.style.display = 'block';

        const copyBtn = document.getElementById('oxira-ai-copy');
        if (copyBtn) {
          copyBtn.addEventListener('click', function () {
            navigator.clipboard.writeText(text || '').catch(function () {});
          });
        }
      }

      async function callAI(action, endpoint) {
        const status = document.getElementById('oxira-ai-status');
        const result = document.getElementById('oxira-ai-result');
        if (status) {
          status.style.display = 'block';
          status.textContent = 'Gerando…';
        }
        if (result) {
          result.style.display = 'none';
          result.innerHTML = '';
        }

        const form = new URLSearchParams();
        form.set('action', action);
        form.set('title', (document.getElementById('id_title')?.value || '').trim());
        form.set('subtitle', (document.getElementById('id_subtitle')?.value || '').trim());
        form.set('angle', (document.getElementById('oxira-ai-angle')?.value || '').trim());
        form.set('content', getEditorHtml());

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'X-CSRFToken': getCSRF(),
          },
          body: form.toString(),
          credentials: 'same-origin',
        });

        const data = await res.json().catch(function () { return null; });
        if (!data || !data.ok) {
          const msg = (data && data.error) ? data.error : ('Erro HTTP ' + res.status);
          if (status) status.textContent = msg;
          return;
        }
        if (status) status.style.display = 'none';
        renderResult(action, data.result || '');
      }

      document.addEventListener('click', function (e) {
        const btn = e.target && e.target.closest ? e.target.closest('.oxira-ai-btn') : null;
        if (btn) {
          e.preventDefault();
          const action = btn.getAttribute('data-action');
          const endpoint = btn.getAttribute('data-endpoint');
          if (!endpoint) return;
          callAI(action, endpoint).catch(function (err) {
            const status = document.getElementById('oxira-ai-status');
            if (status) {
              status.style.display = 'block';
              status.textContent = (err && err.message) ? err.message : 'Falha ao chamar IA.';
            }
          });
          return;
        }

        const apply = e.target && e.target.closest ? e.target.closest('.oxira-ai-apply') : null;
        if (apply) {
          e.preventDefault();
          const target = apply.getAttribute('data-target');
          const value = apply.getAttribute('data-value');
          if (target) setFieldValue(target, value || '');
        }
      });
    })();
  </script>
{% endblock %}
